<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko" lang="ko">
<head>
    <title>BPMN Modeler Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8">


    <!-- jquery -->
    <script type="text/javascript" src="lib/jquery-1.11.1/jquery-1.11.1.min.js"></script>

    <!-- jquery ui -->
    <script type="text/javascript" src="lib/jquery-ui-1.11.0.custom/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="lib/jquery-ui-1.11.0.custom/jquery-ui.css"/>

    <!-- jquery contextmenu -->
    <link rel="stylesheet" type="text/css" href="lib/contextmenu/jquery.contextMenu.css"/>
    <script type="text/javascript" src="lib/contextmenu/jquery.contextMenu-min.js"></script>

    <!-- jquery.layout -->
    <link rel="stylesheet" type="text/css" href="examples/bpmn/css/layout-default-latest.css"/>
    <script type="text/javascript" src="examples/bpmn/js/jquery.layout-latest.js"></script>

    <script type="text/javascript" src="src/raphael-2.1.0-custom.js"></script>
    <script type="text/javascript" src="src/common/Constants.js"></script>
    <script type="text/javascript" src="src/common/Util.js"></script>
    <script type="text/javascript" src="src/common/CurveUtil.js"></script>
    <script type="text/javascript" src="src/common/Exceptions.js"></script>
    <script type="text/javascript" src="src/common/HashMap.js"></script>
    <script type="text/javascript" src="src/common/JSON.js"></script>
    <script type="text/javascript" src="src/geometry/Style.js"></script>
    <script type="text/javascript" src="src/geometry/Coordinate.js"></script>
    <script type="text/javascript" src="src/geometry/Envelope.js"></script>
    <script type="text/javascript" src="src/geometry/Geometry.js"></script>
    <script type="text/javascript" src="src/geometry/PolyLine.js"></script>
    <script type="text/javascript" src="src/geometry/Curve.js"></script>
    <script type="text/javascript" src="src/geometry/Ellipse.js"></script>
    <script type="text/javascript" src="src/geometry/BezierCurve.js"></script>
    <script type="text/javascript" src="src/geometry/Circle.js"></script>
    <script type="text/javascript" src="src/geometry/GeometryCollection.js"></script>
    <script type="text/javascript" src="src/geometry/Line.js"></script>
    <script type="text/javascript" src="src/geometry/Point.js"></script>
    <script type="text/javascript" src="src/geometry/Polygon.js"></script>
    <script type="text/javascript" src="src/geometry/Rectangle.js"></script>

    <!--Shape-->
    <script type="text/javascript" src="src/shape/IShape.js"></script>
    <script type="text/javascript" src="src/shape/GeomShape.js"></script>
    <script type="text/javascript" src="src/shape/TextShape.js"></script>
    <script type="text/javascript" src="src/shape/ImageShape.js"></script>
    <script type="text/javascript" src="src/shape/EdgeShape.js"></script>
    <script type="text/javascript" src="src/shape/CircleShape.js"></script>
    <script type="text/javascript" src="src/shape/EllipseShape.js"></script>
    <script type="text/javascript" src="src/shape/GroupShape.js"></script>
    <script type="text/javascript" src="src/shape/HorizontalLaneShape.js"></script>
    <script type="text/javascript" src="src/shape/HorizontalPoolShape.js"></script>
    <script type="text/javascript" src="src/shape/HtmlShape.js"></script>
    <script type="text/javascript" src="src/shape/RectangleShape.js"></script>
    <script type="text/javascript" src="src/shape/VerticalLaneShape.js"></script>
    <script type="text/javascript" src="src/shape/VerticalPoolShape.js"></script>
    <script type="text/javascript" src="src/shape/Transformer.js"></script>
    <script type="text/javascript" src="src/shape/From.js"></script>
    <script type="text/javascript" src="src/shape/To.js"></script>


    <!--Assensia-->
    <script type="text/javascript" src="src/shape/essencia/Alpha.js"></script>
    <script type="text/javascript" src="src/shape/essencia/State.js"></script>
    <script type="text/javascript" src="src/shape/essencia/LevelOfDetail.js"></script>
    <script type="text/javascript" src="src/shape/essencia/Competency.js"></script>
    <script type="text/javascript" src="src/shape/essencia/Practice.js"></script>
    <script type="text/javascript" src="src/shape/essencia/ActivitySpace.js"></script>
    <script type="text/javascript" src="src/shape/essencia/Activity.js"></script>
    <script type="text/javascript" src="src/shape/essencia/WorkProduct.js"></script>
    <script type="text/javascript" src="src/shape/essencia/CompetencyLevel.js"></script>
    <script type="text/javascript" src="src/shape/essencia/ActivityArrow.js"></script>


    <!--Bpmn-->
    <script type="text/javascript" src="src/shape/bpmn/A_Subprocess.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_Task.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_MapperTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_HumanTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_ManualTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_LoopTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_ServiceTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/A_WebServiceTask.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/ParallelMultiple.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/C_Association.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/C_Conditional.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/C_DataAssociation.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/C_Message.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/C_Sequence.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/D_Data.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/D_Store.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/Event.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/Signal.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/Value_Chain.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/Value_Chain_Module.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Connector.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Cancel.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Compensation.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Error.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Link.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Message.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_End_Multiple.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Compensation.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Error.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Link.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Message.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Multiple.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Rule.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Timer.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_MessageFill.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Intermediate_Escalation.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Connector.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Error.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Link.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Message.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Multiple.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Rule.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/E_Start_Timer.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/G_Gateway.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/G_Complex.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/G_Exclusive.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/G_Inclusive.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/G_Parallel.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/M_Annotation.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/M_Group.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/M_Text.js"></script>
    <script type="text/javascript" src="src/shape/bpmn/ScopeActivity.js"></script>


    <script type="text/javascript" src="src/renderer/IRenderer.js"></script>
    <script type="text/javascript" src="src/renderer/RaphaelRenderer.js"></script>
    <script type="text/javascript" src="src/handler/EventHandler.js"></script>
    <script type="text/javascript" src="src/graph/Canvas.js"></script>

    <script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>


    <script type="text/javascript">
        var canvas, opengraphJSON;

        $(document).ready(function () {
            // OpenGraph Canvas
            canvas = new OG.Canvas('canvas', null, 'white', 'url(./images/grid.gif)');
            canvas._CONFIG.DEFAULT_STYLE.EDGE["edge-type"] = "straight";
            canvas.initConfig({
                selectable: true,
                dragSelectable: true,
                movable: true,
                resizable: false,
                connectable: true,
                selfConnectable: false,
                connectCloneable: false,
                connectRequired: true,
                labelEditable: false,
                groupDropable: false,
                collapsible: false,
                enableHotKey: false,
                enableContextMenu: false,
                autoExtensional: false
            });

            // Tree1
            $("#tree1").jstree({
                "core": {
                    "animation": 0
                },
                "themes": {
                    "theme": "classic",
                    "dots": false,
                    "icons": true
                },
                "plugins": ["themes", "json_data"],
                "json_data": {
                    "data": [
                        {
                            "data": "getSchemaLocation",
                            "attr": {"id": "tree1_1"},
                            "state": "open",
                            "children": [
                                {
                                    "data": "Variables",
                                    "attr": {"id": "tree1_2"},
//                            "state"   : "open",
                                    "children": [
                                        {
                                            "data": "Duration",
                                            "attr": {"id": "tree1_21"}
                                        },
                                        {
                                            "data": "notes",
                                            "attr": {"id": "tree1_22"}
                                        },
                                        {
                                            "data": "startDate",
                                            "attr": {"id": "tree1_23"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Roles",
                                    "attr": {"id": "tree1_3"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "Initiator",
                                            "attr": {"id": "tree1_31"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Instance",
                                    "attr": {"id": "tree1_4"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "instanceId",
                                            "attr": {"id": "tree1_41"}
                                        },
                                        {
                                            "data": "name",
                                            "attr": {"id": "tree1_42"}
                                        },
                                        {
                                            "data": "locale",
                                            "attr": {"id": "tree1_43"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Activities",
                                    "attr": {"id": "tree1_5"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "Schedule",
                                            "attr": {"id": "tree1_51"},
                                            "state": "open",
                                            "children": [
                                                {
                                                    "data": "startedTime",
                                                    "attr": {"id": "tree1_511"}
                                                },
                                                {
                                                    "data": "endTime",
                                                    "attr": {"id": "tree1_512"}
                                                },
                                                {
                                                    "data": "dueDate",
                                                    "attr": {"id": "tree1_513"}
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }).bind('loaded.jstree', function (event, data) {
                drawTerminal('tree1', true);
            }).bind('after_open.jstree', function (event, data) {
                drawTerminal('tree1', true);
            }).bind('after_close.jstree', function (event, data) {
                drawTerminal('tree1', true);
            });

            // Tree2
            $("#tree2").jstree({
                "core": {
                    "rtl": true,
                    "animation": 0
                },
                "themes": {
                    "theme": "classic",
                    "dots": false,
                    "icons": true
                },
                "plugins": ["themes", "json_data"],
                "json_data": {
                    "data": [
                        {
                            "data": "getSchemaLocation",
                            "attr": {"id": "tree2_1"},
                            "state": "open",
                            "children": [
                                {
                                    "data": "Variables",
                                    "attr": {"id": "tree2_2"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "Duration",
                                            "attr": {"id": "tree2_21"}
                                        },
                                        {
                                            "data": "notes",
                                            "attr": {"id": "tree2_22"}
                                        },
                                        {
                                            "data": "startDate",
                                            "attr": {"id": "tree2_23"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Roles",
                                    "attr": {"id": "tree2_3"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "Initiator",
                                            "attr": {"id": "tree2_31"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Instance",
                                    "attr": {"id": "tree2_4"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "instanceId",
                                            "attr": {"id": "tree2_41"}
                                        },
                                        {
                                            "data": "name",
                                            "attr": {"id": "tree2_42"}
                                        },
                                        {
                                            "data": "locale",
                                            "attr": {"id": "tree2_43"}
                                        }
                                    ]
                                },
                                {
                                    "data": "Activities",
                                    "attr": {"id": "tree2_5"},
                                    "state": "open",
                                    "children": [
                                        {
                                            "data": "Schedule",
                                            "attr": {"id": "tree2_51"},
                                            "state": "open",
                                            "children": [
                                                {
                                                    "data": "startedTime",
                                                    "attr": {"id": "tree2_511"}
                                                },
                                                {
                                                    "data": "endTime",
                                                    "attr": {"id": "tree2_512"}
                                                },
                                                {
                                                    "data": "dueDate",
                                                    "attr": {"id": "tree2_513"}
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }).bind('loaded.jstree', function (event, data) {
                drawTerminal('tree2', false);
            }).bind('after_open.jstree', function (event, data) {
                drawTerminal('tree2', false);
            }).bind('after_close.jstree', function (event, data) {
                drawTerminal('tree2', false);
            });

            var transformerDrawData = function () {
                var data = [
                    {
                        group: 'Math',
                        name: 'Max',
                        className: 'org.uengine.processdesigner.mapper.transformers.MaxTransformer',
                        inputs: ['in1', 'in2'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Min',
                        className: 'org.uengine.processdesigner.mapper.transformers.MinTransformer',
                        inputs: ['in1', 'in2'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'To Number',
                        className: 'org.uengine.processdesigner.mapper.transformers.NumberTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Sum',
                        className: 'org.uengine.processdesigner.mapper.transformers.SumTransformer',
                        inputs: ['in1', 'in2', 'in3', 'in4', 'in5'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Floor',
                        className: 'org.uengine.processdesigner.mapper.transformers.FloorTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Round',
                        className: 'org.uengine.processdesigner.mapper.transformers.RoundTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Ceil',
                        className: 'org.uengine.processdesigner.mapper.transformers.CeilTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'Math',
                        name: 'Abs',
                        className: 'org.uengine.processdesigner.mapper.transformers.AbsTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'String',
                        name: 'Concat',
                        className: 'org.uengine.processdesigner.mapper.transformers.ConcatTransformer',
                        inputs: ['in1', 'in2', 'in3', 'in4', 'in5'],
                        outputs: ['out']
                    },
                    {
                        group: 'String',
                        name: 'Replace',
                        className: 'org.uengine.processdesigner.mapper.transformers.ReplaceTransformer',
                        inputs: ['in1'],
                        outputs: ['out']
                    },
                    {
                        group: 'String',
                        name: 'NumberFormat',
                        className: 'org.uengine.processdesigner.mapper.transformers.NumberFormatTransformer',
                        inputs: ['in1', 'in2'],
                        outputs: ['out']
                    }
                ];
                return data;
            };

            var setContextMenu = function (canvas) {
                var items = {};
                items['Delete'] = {
                    name: 'Delete', callback: function () {
                        canvas._HANDLER.deleteSelectedShape();
                    }
                };
                var drawData = transformerDrawData();
                $.each(drawData, function (index, data) {
                    var groupName = data.group;
                    var name = data.name;
                    var className = data.className;
                    var inputs = data.inputs;
                    var outputs = data.outputs;
                    if (!items[groupName]) {
                        items[groupName] = {
                            name: groupName,
                            items: {}
                        };
                    }
                    var group = items[groupName];
                    group.items[name] = {
                        name: name,
                        callback: function () {
                            var root = canvas._RENDERER.getRootGroup();
                            var offset = $(root).data('contextOffset');
                            canvas.drawTransformer([offset.x, offset.y], name, inputs, outputs, data);
                        }
                    }
                });

                $.contextMenu({
                    selector: '#' + canvas._RENDERER.getRootElement().id,
                    build: function ($trigger, e) {
                        var root = canvas._RENDERER.getRootGroup();
                        var shape;
                        var newElement;
                        var eventOffset = canvas._HANDLER._getOffset(event);
                        $(root).data('contextOffset', eventOffset);
                        $(canvas._RENDERER.getContainer()).focus();
                        return {
                            items: items
                        };
                    }
                });
            };
            setContextMenu(canvas);

            // connectShape Event Listener
            canvas.onConnectShape(function (event, edgeElement, fromElement, toElement) {
                console.log('connected!', fromElement.id, '--->', toElement.id);
                console.log(fromElement.data, toElement.data);
            });

            // disconnectShape Event Listener
            canvas.onDisconnectShape(function (event, edgeElement, fromElement, toElement) {
                console.log('disconnected!', fromElement.id, '-/->', toElement.id);
            });
            //canvas.drawTransformer([100, 100], 'Concat', ['str1', 'str2', 'str3'], ['out']);
            //canvas.drawTransformer([100, 200], 'Concat', ['str1', 'str2', 'str3'], ['out']);
        });

        /**
         * draw terminal at tree leaf
         * @param treeId
         * @param isLeft
         */
        function drawTerminal(treeId, isLeft) {
            var tree = $('#' + treeId), id, text, shapeId, shapeElement, parentNode, edgeIds, edge, i,
                    isParentOpen = function (node) {
                        var parents = $(node).parents('li');
                        for (i = parents.length - 1; i >= 0; i--) {
                            if (tree.jstree('is_closed', parents[i])) {
                                return false;
                            }
                        }
                        return true;
                    },
                    getParentClosedNode = function (node) {
                        var parents = $(node).parents('li');
                        for (i = parents.length - 1; i >= 0; i--) {
                            if (tree.jstree('is_closed', parents[i])) {
                                return parents[i];
                            }
                        }
                        return null;
                    };

            $('#' + treeId + ' .jstree-leaf').each(function (idx, item) {
                id = $(item).attr('id');
                text = $(item).children('a').text();
                shapeId = (isLeft ? 'FROM_' : 'TO_') + id;

                if (isParentOpen(item) && tree.jstree('is_leaf', item)) {
                    shapeElement = canvas.drawShape(
                            [(isLeft ? 5 : 295), item.offsetTop + item.offsetHeight / 2],
                            (isLeft ? new OG.From() : new OG.To()),
                            [5, 5],
                            {},
                            shapeId
                    );

                    edgeIds = $(shapeElement).attr(isLeft ? "_toedge" : "_fromedge");
                    if (edgeIds) {
                        $.each(edgeIds.split(","), function (indx, edgeId) {
                            edge = canvas.getElementById(edgeId);
                            edge.shape.geom.style.map['stroke-dasharray'] = '';
                        });
                    }

                    $(shapeElement).click("destroy");
                    canvas.removeAllGuide();
                    canvas.redrawConnectedEdge(shapeElement);
                    canvas.show(shapeElement);
                } else {
                    shapeElement = canvas.getElementById(shapeId);
                    if (shapeElement) {
                        parentNode = getParentClosedNode(item);
                        shapeElement = canvas.drawShape(
                                [(isLeft ? 5 : 295), parentNode.offsetTop + parentNode.offsetHeight / 2],
                                (isLeft ? new OG.From() : new OG.To()),
                                [5, 5],
                                {},
                                shapeId
                        );

                        edgeIds = $(shapeElement).attr(isLeft ? "_toedge" : "_fromedge");
                        if (edgeIds) {
                            $.each(edgeIds.split(","), function (indx, edgeId) {
                                edge = canvas.getElementById(edgeId);
                                edge.shape.geom.style.map['stroke-dasharray'] = '--';
                            });
                        }

                        $(shapeElement).click("destroy");
                        canvas.removeAllGuide();
                        canvas.redrawConnectedEdge(shapeElement);
                        canvas.hide(shapeElement);
                    }
                }
            });
        }

        function save() {
            opengraphJSON = canvas.toJSON();
        }

        function load() {
            canvas.loadJSON(opengraphJSON);
            drawTerminal('tree1', true);
            drawTerminal('tree2', false);
        }
    </script>
</head>
<body oncontextmenu="return false">
<div align="center">
    <input type="button" value="saveJSON" onclick="save();"/>
    <input type="button" value="loadJSON" onclick="load();"/>
</div>
<div align="center">
    <div style="position: relative; left: 0; top:20px; width: 700px; height: 400px; background-color: #f6f6f6;">
        <div id="tree1" style="width:200px; height: 400px; float: left; background-color: #f6f6f6;" align="left"></div>
        <div id="canvas" style="width:300px; height: 400px;  float: left;"></div>
        <div id="tree2" style="width:200px; height: 400px; float: left; background-color: #f6f6f6;" align="right"></div>
    </div>
</div>
</body>
</html>